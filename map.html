<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Vietnam Administrative Boundary Dashboard</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* ---------- GLOBAL ---------- */
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;color:#333
    }
    .header{background:#fffE;backdrop-filter:blur(10px);
      padding:1rem 2rem;border-bottom:3px solid #e74c3c;
      box-shadow:0 4px 20px rgba(0,0,0,.1)}
    .header h1{font-size:2rem;font-weight:700;display:flex;gap:10px;color:#2c3e50}
    .header h1 i{color:#e74c3c}

    /* ---------- LAYOUT ---------- */
    .container{
      max-width:1400px;margin:0 auto;padding:2rem;
      display:grid;grid-template-columns:1fr 2fr;gap:2rem;
      height:calc(100vh - 120px)
    }
    .sidebar,.map-container{
      background:#fffE;backdrop-filter:blur(10px);border-radius:15px;
      box-shadow:0 10px 40px rgba(0,0,0,.1)
    }
    .sidebar{padding:2rem;overflow-y:auto}
    .map-container{padding:1rem;position:relative}
    #map{height:100%;border-radius:10px;
         box-shadow:inset 0 2px 10px rgba(0,0,0,.1)}

    /* ---------- COMPONENTS ---------- */
    .control-group{
      margin-bottom:2rem;padding:1.5rem;
      background:linear-gradient(135deg,#f8f9fa,#e9ecef);
      border-radius:10px;border-left:4px solid #e74c3c
    }
    .control-group h3{
      display:flex;gap:8px;margin-bottom:1rem;font-size:1.2rem;color:#2c3e50
    }
    .file-input-group{display:flex;flex-direction:column;gap:10px}
    .file-input-wrapper{
      background:linear-gradient(135deg,#3498db,#2980b9);
      color:#fff;padding:12px 20px;border-radius:8px;text-align:center;
      cursor:pointer;transition:.3s}
    .file-input-wrapper:hover{
      transform:translateY(-2px);
      box-shadow:0 5px 15px rgba(52,152,219,.4)}
    .toggle-group{display:flex;gap:10px;margin:1rem 0}
    .toggle-btn{flex:1;padding:12px;border:none;border-radius:8px;
      font-weight:600;background:#ecf0f1;color:#7f8c8d;cursor:pointer;transition:.3s}
    .toggle-btn.active{
      background:linear-gradient(135deg,#e74c3c,#c0392b);
      color:#fff;transform:translateY(-2px);
      box-shadow:0 5px 15px rgba(231,76,60,.4)}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin:1rem 0}
    .stat-card{background:linear-gradient(135deg,#f39c12,#d68910);color:#fff;
      padding:1rem;border-radius:10px;text-align:center;
      box-shadow:0 5px 15px rgba(243,156,18,.3)}
    .stat-card h4{font-size:.9rem;margin-bottom:.5rem;opacity:.9}
    .stat-card .value{font-size:1.5rem;font-weight:bold}

    .data-table{max-height:300px;overflow-y:auto;border-radius:8px;background:#fff;
      border:1px solid #ddd}
    .data-table table{width:100%;border-collapse:collapse}
    .data-table th,.data-table td{padding:8px 12px;border-bottom:1px solid #eee;font-size:.9rem}
    .data-table th{
      background:linear-gradient(135deg,#34495e,#2c3e50);color:#fff;position:sticky;top:0}
    .data-table tr:nth-child(even){background:#f8f9fa}
    .data-table tr:hover{background:#e3f2fd;cursor:pointer}

    .download-section{
      background:linear-gradient(135deg,#27ae60,#229954);color:#fff;
      padding:2rem;border-radius:10px;margin-top:2rem}
    .download-section a{
      display:inline-block;padding:12px 20px;border-radius:8px;background:#fff;
      color:#229954;font-weight:600;text-decoration:none;
      box-shadow:0 4px 10px rgba(0,0,0,.15)}

    .province-info{display:none;background:#fff;padding:1rem;border-radius:8px;
      margin:1rem 0;border-left:4px solid #3498db}
    .province-info.show{display:block;animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}
                      to{opacity:1;transform:translateY(0)}}

    .legend{position:absolute;bottom:20px;left:20px;background:#fffE;padding:15px;
      border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.2);z-index:1000}
    .legend-item{display:flex;align-items:center;gap:10px;margin-bottom:5px}
    .legend-color{width:20px;height:15px;border-radius:3px;border:1px solid #333}

    @media(max-width:768px){
      .container{grid-template-columns:1fr;height:auto}
      .header h1{font-size:1.5rem}
      .stats-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="header">
    <h1><i class="fas fa-map-marked-alt"></i>Bản đồ Ranh giới Hành chính Việt Nam</h1>
  </div>

  <div class="container">
    <!-- ========== SIDEBAR ========== -->
    <div class="sidebar">
      <!-- Sample data -->
      <div class="control-group">
        <h3><i class="fas fa-database"></i>Dữ liệu mẫu</h3>
        <div class="file-input-group">
          <div class="file-input-wrapper" onclick="loadLocalFile('oldBoundary')">
            <i class="fas fa-eye"></i> Xem ranh giới cũ
          </div>
          <div class="file-input-wrapper" onclick="loadLocalFile('newBoundary')">
            <i class="fas fa-eye"></i> Xem ranh giới mới
          </div>
          <div class="file-input-wrapper"
               style="background:linear-gradient(135deg,#27ae60,#229954)"
               onclick="loadAllLocalFiles()">
            <i class="fas fa-play"></i> Tải tất cả dữ liệu
          </div>
        </div>
      </div>

      <!-- Local upload -->
      <div class="control-group">
        <h3><i class="fas fa-upload"></i>Tải tệp GeoJSON cục bộ</h3>
        <div class="file-input-group">
          <!-- OLD -->
          <label class="file-input-wrapper">
            <input type="file" id="localOld" accept=".geojson,.json" style="display:none">
            <i class="fas fa-file-upload"></i> Chọn ranh giới cũ
          </label>
          <!-- NEW -->
          <label class="file-input-wrapper">
            <input type="file" id="localNew" accept=".geojson,.json" style="display:none">
            <i class="fas fa-file-upload"></i> Chọn ranh giới mới
          </label>
        </div>
      </div>

      <!-- Toggle -->
      <div class="control-group">
        <h3><i class="fas fa-eye"></i>Hiển thị</h3>
        <div class="toggle-group">
          <button id="toggleOld" class="toggle-btn active">Ranh giới cũ</button>
          <button id="toggleNew" class="toggle-btn active">Ranh giới mới</button>
        </div>
      </div>

      <!-- Stats -->
      <div class="control-group">
        <h3><i class="fas fa-chart-bar"></i>Thống kê</h3>
        <div class="stats-grid">
          <div class="stat-card"><h4>Tổng số tỉnh/TP</h4><div id="totalProvinces" class="value">--</div></div>
          <div class="stat-card"><h4>Dân số</h4><div id="totalPopulation" class="value">--</div></div>
          <div class="stat-card"><h4>Diện tích</h4><div id="totalArea" class="value">--</div></div>
          <div class="stat-card"><h4>GRDP 2024</h4><div id="totalGRDP" class="value">--</div></div>
        </div>
      </div>

      <!-- Province info -->
      <div id="provinceInfo" class="province-info">
        <h4 id="provinceName"></h4>
        <div id="provinceDetails"></div>
      </div>

      <!-- Table -->
      <div class="control-group">
        <h3><i class="fas fa-list"></i>Danh sách tỉnh/thành</h3>
        <div id="dataTable" class="data-table">
          <div class="loading"><i class="fas fa-spinner"></i><p>Đang tải dữ liệu...</p></div>
        </div>
      </div>

      <!-- Google Form -->
      <div class="download-section">
        <h3><i class="fas fa-download"></i>Nhận bộ dữ liệu</h3>
        <p>Vui lòng điền email trong biểu mẫu bên dưới để nhận liên kết tải:</p>
        <a href="YOUR_GOOGLE_FORM_URL" target="_blank" rel="noopener">
          <i class="fas fa-paper-plane"></i> Mở Google Form
        </a>
      </div>
    </div>

    <!-- ========== MAP ========== -->
    <div class="map-container">
      <div id="map"></div>
      <div class="legend">
        <h4>Chú thích</h4>
        <div class="legend-item"><div class="legend-color" style="background:#e74c3cB3"></div>Ranh giới cũ</div>
        <div class="legend-item"><div class="legend-color" style="background:#3498dbB3"></div>Ranh giới mới</div>
      </div>
    </div>
  </div>

  <!-- -------------------- JS -------------------- -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script>
  /* ========== GLOBAL VARS ========== */
  let map, oldBoundaryLayer, newBoundaryLayer;
  const boundaryData   = { old:null, new:null };
  const allProvinceData = [];           // extracted from GeoJSON

  /* ========== CONFIG ========== */
  const CONFIG = {
    files:{
      oldBoundary:'/Users/airm1/Downloads/old.geojson',
      newBoundary:'/Users/airm1/Downloads/new.geojson'
    }
  };

  /* Cố định thứ tự cột */
  const FIELDS = [
    'Tỉnh thành mới',
    'Tỉnh thành cũ',
    'TT hành chính',
    'GRDP 2024 (tỷ VND)',
    'Thu ngân sách 2024 (tỷ VND)',
    'Diện tích (km2)',
    'Dân số',
    'ĐVHC cấp xã'
  ];

  /* ========== LOAD DATA ========== */
  function loadLocalFile(type){
    const url = CONFIG.files[type];
    if(!url) return;
    fetch(url).then(r=>r.json())
      .then(geojson=>{
        const key = type==='oldBoundary' ? 'old' : 'new';
        boundaryData[key]=geojson;
        displayBoundary(geojson,key);
        extractDataFromGeoJSON(geojson,key);
        updateDataTable();
        updateStats();
      })
      .catch(err=>alert('Không thể tải '+url+': '+err));
  }
  const loadAllLocalFiles = () => ['oldBoundary','newBoundary'].forEach(loadLocalFile);

  function extractDataFromGeoJSON(g,key){
    if(!g.features) return;
    g.features.forEach(f=>{
      allProvinceData.push({...f.properties,boundaryType:key});
    });
  }

  /* ---- LOCAL FILE UPLOAD ---- */
  document.getElementById('localOld').addEventListener('change', e => handleLocalFile(e, 'old'));
  document.getElementById('localNew').addEventListener('change', e => handleLocalFile(e, 'new'));

  function handleLocalFile(ev, type) {
    const file = ev.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const geojson = JSON.parse(e.target.result);
        boundaryData[type] = geojson;
        displayBoundary(geojson, type);
        extractDataFromGeoJSON(geojson, type);
        updateDataTable();
        updateStats();
      } catch (err) {
        alert('File GeoJSON không hợp lệ: ' + err.message);
      }
    };
    reader.readAsText(file);
  }

  /* ========== MAP ========== */
  function initMap(){
    map = L.map('map').setView([16,108],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {attribution:'© OpenStreetMap'}).addTo(map);
    oldBoundaryLayer = L.layerGroup().addTo(map);
    newBoundaryLayer = L.layerGroup().addTo(map);
  }

  function displayBoundary(gjson,type){
    const color = type==='old' ? '#e74c3c' : '#3498db';
    const layer = type==='old' ? oldBoundaryLayer : newBoundaryLayer;
    layer.clearLayers();
    L.geoJSON(gjson,{
      style:{color,weight:2,opacity:.8,fillOpacity:.3},
      onEachFeature:(feat,ly)=>{
        const p=feat.properties;
        let html='<div style="font-weight:bold;margin-bottom:5px">';
        const nameField=['name','NAME','ten','TEN','province','PROVINCE']
              .find(k=>p[k]);
        html+=nameField ? p[nameField] : '';
        html+='</div>';
        Object.keys(p).forEach(k=>{
          if(!['name','NAME','ten','TEN','province','PROVINCE'].includes(k))
            html+=`<strong>${k}:</strong> ${p[k]}<br>`;
        });
        ly.bindPopup(html);
        ly.on('click',()=>selectProvince(p));
      }
    }).addTo(layer);
    if(gjson.features?.length){
      map.fitBounds(L.geoJSON(gjson).getBounds());
    }
  }

  /* ========== INTERACTION ========== */
  function selectProvince(props){
    const match = allProvinceData.find(r=>
      FIELDS.some(k=> (r[k]||'').toString().toLowerCase() ===
                      (props[k]||'').toString().toLowerCase())
    );
    showProvinceInfo(props,match);
  }

  function showProvinceInfo(props,data){
    const infoDiv   = document.getElementById('provinceInfo');
    const nameDiv   = document.getElementById('provinceName');
    const detailsDiv= document.getElementById('provinceDetails');

    nameDiv.textContent = props['Tỉnh thành mới']||
                          props['Tỉnh thành cũ']||'Không xác định';

    let html='';
    if(data){
      html+='<h5>Thông tin từ dữ liệu:</h5>';
      FIELDS.forEach(k=>{
        const v=data[k];
        if(v) html+=`<p><strong>${k}:</strong> ${formatValue(k,v)}</p>`;
      });
    }
    html+='<h5>Thông tin ranh giới:</h5>';
    Object.entries(props).forEach(([k,v])=>{
      if(v) html+=`<p><strong>${k}:</strong> ${v}</p>`;
    });
    detailsDiv.innerHTML = html;
    infoDiv.classList.add('show');
  }

  /* ========== TABLE & STATS ========== */
  function formatValue(k,v){
    const lk=k.toLowerCase();
    if(lk.includes('grdp')||lk.includes('thu ngân sách'))
      return (+v).toLocaleString('vi-VN')+' tỷ VND';
    if(lk.includes('diện tích'))
      return (+v).toLocaleString('vi-VN')+' km²';
    if(lk.includes('dân số'))
      return parseInt(v).toLocaleString('vi-VN')+' người';
    return v;
  }

  function updateDataTable(){
    const container=document.getElementById('dataTable');
    if(allProvinceData.length===0){
      container.innerHTML='<div class="loading"><i class="fas fa-table"></i><p>Chưa có dữ liệu</p></div>';
      return;
    }
    const headers=FIELDS;
    let html='<table><thead><tr>';
    headers.forEach(h=>html+=`<th>${h}</th>`); html+='</tr></thead><tbody>';
    allProvinceData.forEach((row,i)=>{
      html+=`<tr onclick="selectRowData(${i})">`;
      headers.forEach(h=>html+=`<td>${formatValue(h,row[h]||'')}</td>`);
      html+='</tr>';
    });
    html+='</tbody></table>';
    container.innerHTML = html;
  }
  const selectRowData=i=>showProvinceInfo({},allProvinceData[i]);

  function updateStats(){
    let totalProvinces=0,totalPopulation=0,totalArea=0,totalGRDP=0;
    if(allProvinceData.length){
      const seen=new Set();
      allProvinceData.forEach(r=>{
        const name=r['Tỉnh thành mới']||r['Tỉnh thành cũ'];
        if(name) seen.add(name.trim());
        totalPopulation+=+r['Dân số']||0;
        totalArea      +=+r['Diện tích (km2)']||0;
        totalGRDP      +=+r['GRDP 2024 (tỷ VND)']||0;
      });
      totalProvinces=seen.size;
    }
    document.getElementById('totalProvinces').textContent=totalProvinces||'--';
    document.getElementById('totalPopulation').textContent=
      totalPopulation? (totalPopulation/1e6).toFixed(1)+'M':'--';
    document.getElementById('totalArea').textContent=
      totalArea? totalArea.toLocaleString('vi-VN')+' km²':'--';
    document.getElementById('totalGRDP').textContent=
      totalGRDP? totalGRDP.toLocaleString('vi-VN')+' tỷ':'--';
  }

  /* ========== TOGGLE BUTTONS ========== */
  document.getElementById('toggleOld').onclick=function(){
    this.classList.toggle('active');
    map.hasLayer(oldBoundaryLayer)? map.removeLayer(oldBoundaryLayer)
                                  : map.addLayer(oldBoundaryLayer);
  };
  document.getElementById('toggleNew').onclick=function(){
    this.classList.toggle('active');
    map.hasLayer(newBoundaryLayer)? map.removeLayer(newBoundaryLayer)
                                  : map.addLayer(newBoundaryLayer);
  };

  /* ========== INIT ========== */
  document.addEventListener('DOMContentLoaded',()=>{
    initMap();
    loadAllLocalFiles();
  });
  </script>
</body>
</html>